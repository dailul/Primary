<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
 <script>
    
    
    class MyPromise{
    constructor(executor) {
        this.status = "pending";     // åˆå§‹åŒ–çŠ¶æ€ä¸ºpending
        this.value = undefined;      // åˆå§‹åŒ–è¿”å›žçš„æˆåŠŸçš„ç»“æžœæˆ–è€…å¤±è´¥çš„åŽŸå› 
        this.resolveArr = [];        // åˆå§‹åŒ–thenä¸­æˆåŠŸçš„æ–¹æ³•
        this.rejectArr = [];         // åˆå§‹åŒ–thenä¸­å¤±è´¥çš„æ–¹æ³•
        
        
        // å®šä¹‰changeæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å‘çŽ°å¥½åƒresolveå’Œrejectæ–¹æ³•å…±åŒçš„åœ°æ–¹è¿˜æŒºå¤šðŸ¤”
        let change = (status, value) => {
            if(this.status !== "pending") return; // çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜
            this.status = status;
            this.value = value;
            console.log(222222)
            
            // æ ¹æ®çŠ¶æ€åˆ¤æ–­è¦æ‰§è¡ŒæˆåŠŸçš„æ–¹æ³•æˆ–å¤±è´¥çš„æ–¹æ³•
            let fnArr = status === "resolved" ? this.resolveArr : this.rejectArr;
            
            // fnArrä¸­çš„æ–¹æ³•ä¾æ¬¡æ‰§è¡Œ
            fnArr.forEach(item => {
                if(typeof item !== "function") return;
                item(this. value);
            })
        }
        // è¿™é‡Œæ˜¯resolveæ–¹æ³•ï¼ŒæˆåŠŸåŽæ‰§è¡Œï¼Œå°†çŠ¶æ€æ”¹å˜ä¸ºresolvedï¼Œå¹¶ä¸”å°†ç»“æžœè¿”å›ž
        let resolve = result => {
            change("resolved", result)
        }
        
        // è¿™é‡Œæ˜¯rejectæ–¹æ³•ï¼Œå¼‚å¸¸æ—¶æ‰§è¡Œï¼ŒçŠ¶æ€æ”¹ä¸ºrejectedï¼Œå¹¶ä¸”å°†å¤±è´¥çš„åŽŸå› è¿”å›ž
        let reject = reason => {
            change("rejected", reason);
        }
        
        // tryã€catchæ•èŽ·å¼‚å¸¸ï¼Œå¦‚æžœé”™è¯¯ï¼Œæ‰§è¡Œrejectæ–¹æ³•
        try {
            executor(resolve, reject)
        } catch(err) {
            reject(err)
        }
    }
    
    then(resolveFn, rejectFn) {
    // å¦‚æžœä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ç›´æŽ¥æ‰§è¡Œè¿”å›žç»“æžœ
        console.log(resolveFn, rejectFn)
        if(typeof resolveFn !== "function") {
            resolveFn = result => {
                return result;
            }
        }
        
        if(typeof rejectFn !== "function") {
            rejectFn = reason => {
                return MyPromise.reject(reason);
            }
        }
        
        return new MyPromise((resolve, reject) => {
            this.resolveArr.push(result => {
                try {
                    let x = resolveFn(result);  // èŽ·å–æ‰§è¡ŒæˆåŠŸæ–¹æ³•è¿”å›žçš„ç»“æžœ
                    
                    // å¦‚æžœxæ˜¯ä¸€ä¸ªpromiseå®žä¾‹ï¼Œåˆ™ç»§ç»­è°ƒç”¨thenæ–¹æ³• ==> thené“¾çš„å®žçŽ°
                    if(x instanceof MyPromise) {
                        x.then(resolve, reject)
                        return;
                    }
                    
                    // ä¸æ˜¯promiseå®žä¾‹ï¼Œç›´æŽ¥æ‰§è¡ŒæˆåŠŸçš„æ–¹æ³•
                    resolve(x);
                } catch(err) {
                    reject(err)
                }
            })
            
            this.rejectArr.push(reason => {
                try {
                    let x = rejectFn(reason);
                    
                    if(x instanceof MyPromise) {
                        x.then(resolve, reject)
                        return;
                    }
                    
                    resolve(x);
                } catch(err) {
                    reject(err)
                }
            })
        })
    }
}

    
    
    
    
    
new MyPromise((resolve, reject) => {
    resolve(1);
    debugger
}).then(res => {
    console.log(res, 'success');
}, err => {
    console.log(err, 'error');
})
   
</script>   
</body>
</html>